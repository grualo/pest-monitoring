<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PestiLog ‚Äì Farmer Pest Monitor</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Leaflet MarkerCluster CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    html, body {
      height: 100%;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 16px;
      background: #f5f5f5;
      font-size: 14px;
    }

    h1, h2, h3 {
      margin-top: 0.5em;
      margin-bottom: 0.3em;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* One field per line, always */
    .flex-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 4px;
      width: 100%;
    }

    .field-group label {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .field-group input,
    .field-group select,
    .field-group textarea {
      padding: 6px 9px;
      font-size: 0.95rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
    }

    textarea {
      min-height: 50px;
      resize: vertical;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      margin-top: 8px;
      margin-right: 6px;
    }

    .btn-primary {
      background-color: #1976d2;
      color: white;
    }

    .btn-secondary {
      background-color: #e0e0e0;
      color: #333;
    }

    .btn-warning {
      background-color: #fbc02d;
      color: #333;
    }

    .section {
      margin-top: 24px;
      padding-top: 12px;
      border-top: 1px solid #ddd;
    }

    .section-map {
      margin-top: 24px;
      padding-top: 12px;
      border-top: 1px solid #ddd;
    }

    .note {
      font-size: 0.8rem;
      font-style: italic;
      margin-top: 4px;
    }

    .status {
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .status-ok { color: #2e7d32; }
    .status-error { color: #c62828; }

    /* üî• Full-screen map section */
    #map {
      width: 100%;
      height: 100vh;   /* full viewport height */
      margin-top: 8px;
      border-radius: 0;
      border: 1px solid #ccc;
    }

    /* Base crop-marker style */
    .crop-marker {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid #1976d2;
      background-color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 2px rgba(0,0,0,0.4);
      font-size: 13px;
      transition: transform 0.15s ease;
    }

    .ring-low { border-color: #2e7d32; }
    .ring-moderate { border-color: #f9a825; }
    .ring-high { border-color: #c62828; }

    .zoom-small .crop-marker { transform: scale(0.7); }
    .zoom-medium .crop-marker { transform: scale(0.9); }
    .zoom-large .crop-marker { transform: scale(1.15); }

    .hidden { display: none !important; }

    /* üì± MOBILE: BIGGER EVERYTHING */
    @media (max-width: 768px) {
      body {
        margin: 0;
        font-size: 22px;              /* base text size */
      }

      .container {
        padding: 14px;
        border-radius: 0;
        box-shadow: none;
      }

      h1 {
        font-size: 2.2rem;
      }

      h2 {
        font-size: 1.7rem;
      }

      .note,
      .status {
        font-size: 1.1rem;
      }

      .field-group label {
        font-size: 1.25rem;
      }

      .field-group input,
      .field-group select,
      .field-group textarea {
        font-size: 1.25rem;          /* bigger controls */
        padding: 12px 14px;
      }

      .btn {
        width: 100%;
        margin-right: 0;
        font-size: 1.35rem;
        padding: 14px 18px;
      }

      #map {
        height: 100vh;               /* full-screen map on mobile */
        border-radius: 0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>PestiLog ‚Äì Farmer Pest Monitor</h1>
    <p class="note">
      Severity rule: <strong>Low</strong> &lt; 10% &nbsp;&nbsp;|&nbsp;&nbsp;
      <strong>Moderate</strong> 10‚Äì30% &nbsp;&nbsp;|&nbsp;&nbsp;
      <strong>High</strong> &gt; 30%
    </p>

    <!-- Farmer Field Form -->
    <div class="section">
      <h2>Farmer Field Form (Input)</h2>
      <form id="pestForm" onsubmit="event.preventDefault(); addRecord();">
        <div class="flex-row">
          <div class="field-group">
            <label for="date">Date</label>
            <input type="date" id="date" />
          </div>

          <div class="field-group">
            <label for="barangay">Barangay</label>
            <input type="text" id="barangay" placeholder="e.g. San Juan" />
          </div>

          <div class="field-group">
            <label for="farmerId">Farmer / Field ID</label>
            <input type="text" id="farmerId" placeholder="e.g. F-001" />
          </div>

          <div class="field-group">
            <label for="crop">Crop</label>
            <select id="crop" onchange="updatePestOptions()">
              <option value="">-- Select crop --</option>
              <option value="Rice">Rice</option>
              <option value="Corn">Corn</option>
              <option value="Cassava">Cassava</option>
              <option value="Tomato">Tomato</option>
              <option value="Eggplant">Eggplant</option>
              <option value="Okra">Okra</option>
            </select>
          </div>

          <div class="field-group">
            <label for="pest">Pest (Common Name)</label>
            <select id="pest" onchange="updateScientificName()">
              <option value="">-- Select pest --</option>
            </select>
          </div>

          <div class="field-group">
            <label for="scientificName">Scientific Name</label>
            <input type="text" id="scientificName" readonly />
          </div>

          <div class="field-group">
            <label for="growthStage">Growth Stage</label>
            <select id="growthStage">
              <option value="">-- Select stage --</option>
              <option value="Seedling">Seedling</option>
              <option value="Vegetative">Vegetative</option>
              <option value="Reproductive">Reproductive</option>
              <option value="Maturation">Maturation</option>
            </select>
          </div>

          <div class="field-group">
            <label for="weather">Weather Condition</label>
            <select id="weather">
              <option value="">-- Select weather --</option>
              <option value="Sunny">Sunny</option>
              <option value="Cloudy">Cloudy</option>
              <option value="Rainy">Rainy</option>
              <option value="Windy">Windy</option>
            </select>
          </div>

          <div class="field-group">
            <label for="samplingUnit">Sampling Unit</label>
            <select id="samplingUnit"></select>
            <div id="samplingHint" class="note"></div>
          </div>

          <div class="field-group">
            <label for="plantsSampled">No. of Plants Sampled</label>
            <input type="number" id="plantsSampled" min="0" />
          </div>

          <div class="field-group">
            <label for="pestCount">Pest Count per Unit</label>
            <input type="number" id="pestCount" min="0" step="0.1" />
          </div>

          <div class="field-group">
            <label for="damage">Percent Damage (%)</label>
            <input type="number" id="damage" min="0" max="100" step="0.1"
                   oninput="updateSeverityPreview()" />
          </div>

          <div class="field-group">
            <label>Severity (auto)</label>
            <input type="text" id="severityPreview" readonly />
          </div>

          <!-- Coordinates hidden but still used -->
          <div class="field-group hidden">
            <label for="lat">Latitude</label>
            <input type="number" id="lat" step="0.000001" />
          </div>

          <div class="field-group hidden">
            <label for="lng">Longitude</label>
            <input type="number" id="lng" step="0.000001" />
          </div>

          <div class="field-group">
            <label>&nbsp;</label>
            <button type="button" class="btn btn-secondary" onclick="useMyLocation()">
              üìç Use my location
            </button>
          </div>

          <div class="field-group">
            <label for="notes">Notes / Recommendation</label>
            <textarea id="notes" placeholder="e.g. Apply biological control, monitor next 3 days."></textarea>
          </div>
        </div>

        <div class="flex-row">
          <button type="submit" class="btn btn-primary">‚ûï Add Record</button>
          <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
          <button type="button" class="btn btn-warning" onclick="loadFromSheet()">‚¨á Load from Google Sheet</button>
        </div>
        <div id="syncStatus" class="status"></div>
      </form>
    </div>

    <!-- Filters + Download BEFORE map -->
    <div class="section">
      <h2>Filters & Download</h2>
      <p class="note">Filters apply to both the map and the downloadable CSV.</p>
      <div class="flex-row">
        <div class="field-group">
          <label for="filterBarangay">Filter by Barangay</label>
          <input type="text" id="filterBarangay" placeholder="e.g. San Juan"
                 oninput="updateMapMarkers();" />
        </div>

        <div class="field-group">
          <label for="filterCrop">Filter by Crop</label>
          <select id="filterCrop" onchange="onFilterCropChange();">
            <option value="">All crops</option>
            <option value="Rice">Rice</option>
            <option value="Corn">Corn</option>
            <option value="Cassava">Cassava</option>
            <option value="Tomato">Tomato</option>
            <option value="Eggplant">Eggplant</option>
            <option value="Okra">Okra</option>
          </select>
        </div>

        <div class="field-group">
          <label for="filterPest">Filter by Pest</label>
          <select id="filterPest" onchange="updateMapMarkers();">
            <option value="">All pests</option>
          </select>
        </div>
      </div>

      <button type="button" class="btn btn-primary" onclick="downloadFilteredCSV()">
        ‚¨á Download Filtered Records (CSV)
      </button>
    </div>

    <!-- Full-screen Map -->
    <div class="section-map">
      <h2>Map of Pest Records</h2>
      <p class="note">
        Markers: crop emoji + colored ring (green = Low, yellow = Moderate, red = High).  
        Map respects filters above; markers cluster when many overlap. Icons scale slightly with zoom.
      </p>
      <div id="map"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Leaflet MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.js"></script>

  <!-- OverlappingMarkerSpiderfier for Leaflet -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script>

  <script>
    const SHEET_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwL275ZF10RP-DUySTsZErI4tZdlAwczFRTte1kz_cHYYZvt1V7GT6evTGhx2BRBeIL/exec';

    const pestMap = {
      "Rice": [
        { common: "Rice stem borer", sci: "Scirpophaga incertulas" },
        { common: "Brown planthopper", sci: "Nilaparvata lugens" },
        { common: "Green leafhopper", sci: "Nephotettix virescens" },
        { common: "Rice bug", sci: "Leptocorisa oratorius" },
        { common: "Rice black bug", sci: "Scotinophara coarctata" },
        { common: "Armyworm", sci: "Mythimna separata" },
        { common: "Leaf folder", sci: "Cnaphalocrocis medinalis" }
      ],
      "Corn": [
        { common: "Corn borer", sci: "Ostrinia furnacalis" },
        { common: "Fall armyworm", sci: "Spodoptera frugiperda" },
        { common: "Corn earworm", sci: "Helicoverpa armigera" },
        { common: "Aphids", sci: "Rhopalosiphum maidis" },
        { common: "Cutworms", sci: "Agrotis ipsilon" }
      ],
      "Cassava": [
        { common: "Cassava mealybug", sci: "Phenacoccus manihoti" },
        { common: "Cassava green mite", sci: "Mononychellus tanajoa" },
        { common: "Whitefly", sci: "Bemisia tabaci" },
        { common: "Spiraling whitefly", sci: "Aleurodicus dispersus" },
        { common: "Scale insects", sci: "Paracoccus marginatus" }
      ],
      "Tomato": [
        { common: "Tomato fruitworm", sci: "Helicoverpa armigera" },
        { common: "Whitefly", sci: "Bemisia tabaci" },
        { common: "Aphids", sci: "Aphis gossypii" },
        { common: "Thrips", sci: "Thrips tabaci" },
        { common: "Leafminers", sci: "Liriomyza trifolii" },
        { common: "Cutworms", sci: "Agrotis ipsilon" }
      ],
      "Eggplant": [
        { common: "Eggplant fruit and shoot borer", sci: "Leucinodes orbonalis" },
        { common: "Aphids", sci: "Aphis gossypii" },
        { common: "Thrips", sci: "Thrips palmi" },
        { common: "Whiteflies", sci: "Bemisia tabaci" },
        { common: "Mites", sci: "Tetranychus urticae" }
      ],
      "Okra": [
        { common: "Aphids", sci: "Aphis gossypii" },
        { common: "Whiteflies", sci: "Bemisia tabaci" },
        { common: "Fruit borers", sci: "Helicoverpa armigera" },
        { common: "Leafhoppers", sci: "Amrasca biguttula" },
        { common: "Mites", sci: "Tetranychus urticae" }
      ]
    };

    const cropDefaultUnits = {
      "Rice": ["Hill", "Tiller", "Leaf", "Panicle"],
      "Corn": ["Plant", "Row-meter", "Whorl", "Ear"],
      "Cassava": ["Plant", "Leaf", "Shoot"],
      "Tomato": ["Plant", "Leaf", "Fruit"],
      "Eggplant": ["Plant", "Shoot", "Fruit"],
      "Okra": ["Plant", "Leaf", "Fruit"],
      "_default": ["Hill", "Plant", "Leaf", "Panicle/Fruit", "Row-meter"]
    };

    const pestSamplingUnits = {
      "Rice stem borer": ["Hill", "Tiller", "Plant"],
      "Brown planthopper": ["Hill", "Plant", "Stem base"],
      "Green leafhopper": ["Hill", "Plant", "Leaf"],
      "Rice bug": ["Hill", "Panicle", "Plant"],
      "Rice black bug": ["Hill", "Plant"],
      "Armyworm": ["Plant", "Row-meter"],
      "Leaf folder": ["Leaf", "Plant"],

      "Corn borer": ["Plant", "Stem", "Ear"],
      "Fall armyworm": ["Plant", "Whorl", "Row-meter"],
      "Corn earworm": ["Ear", "Plant"],
      "Aphids": ["Leaf", "Plant"],
      "Cutworms": ["Plant", "Hill", "Row-meter"],

      "Cassava mealybug": ["Leaf", "Shoot", "Plant"],
      "Cassava green mite": ["Leaf", "Plant"],
      "Whitefly": ["Leaf", "Plant"],
      "Spiraling whitefly": ["Leaf", "Plant"],
      "Scale insects": ["Leaf", "Stem", "Plant"],

      "Tomato fruitworm": ["Fruit", "Plant"],
      "Thrips": ["Leaf", "Flower", "Plant"],
      "Leafminers": ["Leaf", "Plant"],

      "Eggplant fruit and shoot borer": ["Shoot", "Fruit", "Plant"],

      "Fruit borers": ["Fruit", "Plant"],
      "Leafhoppers": ["Leaf", "Plant"],

      "_default": ["Hill", "Plant", "Leaf", "Panicle/Fruit", "Row-meter"]
    };

    const records = [];
    let map, markersLayer, oms;

    function initMap() {
      map = L.map('map', {
        minZoom: 5,
        maxZoom: 18,
        zoomControl: true
      }).setView([12.5, 122], 5);

      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: '&copy; Esri'
      });

      const terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17,
        attribution: '&copy; OpenTopoMap'
      });

      const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        attribution: '&copy; CartoDB'
      });

      const baseLayers = {
        "OpenStreetMap": osm,
        "Satellite (Esri)": esriSat,
        "Terrain (OpenTopoMap)": terrain,
        "Dark Mode (Carto)": dark
      };

      if (L.markerClusterGroup) {
        markersLayer = L.markerClusterGroup();
        map.addLayer(markersLayer);
        L.control.layers(baseLayers, { "Pest Records": markersLayer }).addTo(map);
      } else {
        console.warn("MarkerCluster plugin not loaded; using simple LayerGroup.");
        markersLayer = L.layerGroup().addTo(map);
        L.control.layers(baseLayers, { "Pest Records": markersLayer }).addTo(map);
      }

      // OverlappingMarkerSpiderfier
      oms = new OverlappingMarkerSpiderfier(map, {
        keepSpiderfied: true,
        nearbyDistance: 20
      });

      oms.addListener('click', function(marker) {
        marker.openPopup();
      });

      oms.addListener('spiderfy', function(markers) {
        markers.forEach(m => m.closePopup());
      });

      updateZoomScaleClass();
      map.on('zoomend', updateZoomScaleClass);
    }

    function updateZoomScaleClass() {
      if (!map) return;
      const z = map.getZoom();
      const container = map.getContainer();
      container.classList.remove('zoom-small', 'zoom-medium', 'zoom-large');

      if (z <= 6)      container.classList.add('zoom-small');
      else if (z <=10) container.classList.add('zoom-medium');
      else             container.classList.add('zoom-large');
    }

    function autoFillDate() {
      const dateInput = document.getElementById("date");
      if (!dateInput) return;
      const today = new Date().toISOString().slice(0, 10);
      dateInput.value = today;
    }

    function useMyLocation() {
      const latInput = document.getElementById("lat");
      const lngInput = document.getElementById("lng");

      if (!navigator.geolocation) {
        alert("Geolocation is not supported by this browser.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          latInput.value = latitude.toFixed(6);
          lngInput.value = longitude.toFixed(6);
          if (typeof map !== "undefined") {
            map.setView([latitude, longitude], 15);
          }
        },
        (err) => {
          console.error(err);
          alert("Unable to get location. Please check permissions.");
        }
      );
    }

    function updatePestOptions() {
      const crop = document.getElementById("crop").value;
      const pestSelect = document.getElementById("pest");
      const sciInput = document.getElementById("scientificName");
      pestSelect.innerHTML = '<option value="">-- Select pest --</option>';
      sciInput.value = "";

      updateSamplingUnits(crop, "");

      if (!crop || !pestMap[crop]) return;
      pestMap[crop].forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.common;
        opt.textContent = p.common;
        pestSelect.appendChild(opt);
      });
    }

    function updateScientificName() {
      const crop = document.getElementById("crop").value;
      const pest = document.getElementById("pest").value;
      const sciInput = document.getElementById("scientificName");
      sciInput.value = "";
      if (!crop || !pest || !pestMap[crop]) {
        updateSamplingUnits(crop, "");
        return;
      }
      const match = pestMap[crop].find(p => p.common === pest);
      if (match) sciInput.value = match.sci;
      updateSamplingUnits(crop, pest);
    }

    function computeSeverity(damage) {
      if (damage === "" || isNaN(damage)) return "";
      const val = parseFloat(damage);
      if (val < 10) return "Low";
      if (val < 30) return "Moderate";
      return "High";
    }

    function updateSeverityPreview() {
      const damage = document.getElementById("damage").value;
      const severity = computeSeverity(damage);
      document.getElementById("severityPreview").value = severity;
    }

    function clearForm() {
      document.getElementById("pestForm").reset();
      document.getElementById("scientificName").value = "";
      document.getElementById("severityPreview").value = "";
      document.getElementById("pest").innerHTML = '<option value="">-- Select pest --</option>';
      autoFillDate();
      updateSamplingUnits("", "");
      const status = document.getElementById("syncStatus");
      if (status) {
        status.textContent = "";
        status.className = "status";
      }
    }

    function updateSamplingUnits(crop, pestName) {
      const su   = document.getElementById("samplingUnit");
      const hint = document.getElementById("samplingHint");
      su.innerHTML = "";

      let units;
      let label;

      if (pestName && pestSamplingUnits[pestName]) {
        units = pestSamplingUnits[pestName];
        label = `Suggested units for this pest type (${pestName}): `;
      } else if (crop && cropDefaultUnits[crop]) {
        units = cropDefaultUnits[crop];
        label = `Suggested units for this crop (${crop}) pests: `;
      } else {
        units = pestSamplingUnits["_default"];
        label = "Suggested general units: ";
      }

      units.forEach(u => {
        const opt = document.createElement("option");
        opt.value = u;
        opt.textContent = u;
        su.appendChild(opt);
      });

      if (hint) hint.textContent = label + units.join(", ");
    }

    function getCropEmoji(crop) {
      switch (crop) {
        case "Rice":     return "üåæ";
        case "Corn":     return "üåΩ";
        case "Cassava":  return "ü•î";
        case "Tomato":   return "üçÖ";
        case "Eggplant": return "üçÜ";
        case "Okra":     return "ü•í";
        default:         return "üå±";
      }
    }

    function getSeverityRingClass(severity) {
      if (severity === "Low")      return "ring-low";
      if (severity === "Moderate") return "ring-moderate";
      if (severity === "High")     return "ring-high";
      return "";
    }

    function makeCropIcon(crop, severity) {
      const emoji     = getCropEmoji(crop);
      const ringClass = getSeverityRingClass(severity);
      const html      = `<div class="crop-marker ${ringClass}">${emoji}</div>`;
      return L.divIcon({
        html,
        className: "",
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
    }

    function addMarker(record) {
      if (!markersLayer) return;
      if (record.lat == null || isNaN(record.lat) || record.lng == null || isNaN(record.lng)) return;

      const icon  = makeCropIcon(record.crop, record.severity);
      const marker = L.marker([record.lat, record.lng], { icon });
      const popupContent = `
        <strong>${record.crop}</strong> ‚Äì ${record.pest}<br/>
        <em>${record.sci}</em><br/>
        Barangay: ${record.barangay || "-"}<br/>
        Damage: ${record.damage || 0}% (${record.severity})<br/>
        Weather: ${record.weather || "-"}<br/>
        Date: ${record.date || "-"}
      `;
      marker.bindPopup(popupContent);
      markersLayer.addLayer(marker);

      if (oms) oms.addMarker(marker);
    }

    function sendToGoogleSheet(data) {
      const status = document.getElementById("syncStatus");
      if (!SHEET_WEBAPP_URL) {
        console.warn("SHEET_WEBAPP_URL is empty ‚Äì skipping POST");
        if (status) {
          status.textContent = "Saved locally only (no Web App URL set).";
          status.className = "status status-error";
        }
        return;
      }

      fetch(SHEET_WEBAPP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      }).then(() => {
        if (status) {
          status.textContent = "Record added and sent to Google Sheet (no-cors).";
          status.className = "status status-ok";
        }
      }).catch(err => {
        console.error("Error sending to Google Sheet:", err);
        if (status) {
          status.textContent = "Record added locally, but failed to send to Google Sheet.";
          status.className = "status status-error";
        }
      });
    }

    // ‚≠ê NEW: ensure coordinates exist, then immediately show new marker
    function addRecord() {
      const latVal = document.getElementById("lat").value;
      const lngVal = document.getElementById("lng").value;
      const lat = parseFloat(latVal);
      const lng = parseFloat(lngVal);

      // Require coordinates so the marker appears on the map
      if (isNaN(lat) || isNaN(lng)) {
        alert("Please tap 'Use my location' before adding a record so it can appear on the map.");
        return;
      }

      const data = {
        date:       document.getElementById("date").value,
        barangay:   document.getElementById("barangay").value.trim(),
        farmerId:   document.getElementById("farmerId").value.trim(),
        crop:       document.getElementById("crop").value,
        pest:       document.getElementById("pest").value,
        sci:        document.getElementById("scientificName").value,
        growth:     document.getElementById("growthStage").value,
        weather:    document.getElementById("weather").value,
        unit:       document.getElementById("samplingUnit").value,
        plants:     document.getElementById("plantsSampled").value,
        pestCount:  document.getElementById("pestCount").value,
        damage:     document.getElementById("damage").value,
        notes:      document.getElementById("notes").value.trim(),
        lat:        lat,
        lng:        lng
      };

      if (!data.crop || !data.pest || data.damage === "") {
        alert("Please fill at least Crop, Pest, and % Damage.");
        return;
      }

      data.severity = computeSeverity(data.damage);
      records.push(data);

      sendToGoogleSheet(data);
      updateMapMarkers();          // add marker based on current filters

      // Focus the map on the new record
      if (map && !isNaN(lat) && !isNaN(lng)) {
        map.setView([lat, lng], 15);
      }

      clearForm();
    }

    function clearAllRecordsUI() {
      records.length = 0;
      if (markersLayer) markersLayer.clearLayers();
    }

    function loadFromSheet() {
      const status = document.getElementById("syncStatus");
      if (status) {
        status.textContent = "Loading from Google Sheet‚Ä¶";
        status.className = "status";
      }

      fetch(SHEET_WEBAPP_URL)
        .then(res => res.json())
        .then(rows => {
          clearAllRecordsUI();
          rows.forEach(r => {
            const rec = {
              date:      r.date || "",
              barangay:  r.barangay || "",
              farmerId:  r.farmerId || "",
              crop:      r.crop || "",
              pest:      r.pest || "",
              sci:       r.sci || "",
              growth:    r.growth || "",
              weather:   r.weather || "",
              unit:      r.unit || "",
              plants:    r.plants || "",
              pestCount: r.pestCount || "",
              damage:    r.damage || "",
              severity:  r.severity || "",
              notes:     r.notes || "",
              lat:       r.lat !== "" && r.lat !== null ? parseFloat(r.lat) : null,
              lng:       r.lng !== "" && r.lng !== null ? parseFloat(r.lng) : null
            };
            records.push(rec);
          });

          updateMapMarkers();

          if (status) {
            status.textContent = "Loaded from Google Sheet ‚úî";
            status.className = "status status-ok";
          }
        })
        .catch(err => {
          console.error("Error loading from Google Sheet:", err);
          if (status) {
            status.textContent = "Error loading from Google Sheet ‚Äì check Web App URL or script output.";
            status.className = "status status-error";
          }
        });
    }

    function getFilters() {
      const fb = document.getElementById("filterBarangay").value.trim().toLowerCase();
      const fc = document.getElementById("filterCrop").value;
      const fp = document.getElementById("filterPest").value;
      return { fb, fc, fp };
    }

    function getFilteredRecords() {
      const { fb, fc, fp } = getFilters();
      return records.filter(rec => {
        if (fb && !(rec.barangay || "").toLowerCase().includes(fb)) return false;
        if (fc && rec.crop !== fc) return false;
        if (fp && rec.pest !== fp) return false;
        return true;
      });
    }

    function updateMapMarkers() {
      if (!markersLayer) return;
      markersLayer.clearLayers();
      const filtered = getFilteredRecords();
      filtered.forEach(rec => addMarker(rec));
    }

    function updateFilterPestOptions() {
      const filterCrop = document.getElementById("filterCrop").value;
      const filterPest = document.getElementById("filterPest");
      if (!filterPest) return;

      const previous = filterPest.value;
      filterPest.innerHTML = '<option value="">All pests</option>';

      if (filterCrop && pestMap[filterCrop]) {
        pestMap[filterCrop].forEach(p => {
          const opt = document.createElement("option");
          opt.value = p.common;
          opt.textContent = p.common;
          filterPest.appendChild(opt);
        });
      } else {
        const pestSet = new Set();
        Object.keys(pestMap).forEach(crop => {
          pestMap[crop].forEach(p => pestSet.add(p.common));
        });
        Array.from(pestSet).sort().forEach(p => {
          const opt = document.createElement("option");
          opt.value = p;
          opt.textContent = p;
          filterPest.appendChild(opt);
        });
      }

      if (previous) {
        const options = Array.from(filterPest.options).map(o => o.value);
        if (options.includes(previous)) filterPest.value = previous;
      }
    }

    function onFilterCropChange() {
      updateFilterPestOptions();
      updateMapMarkers();
    }

    function csvEscape(value) {
      if (value === null || value === undefined) return "";
      const str = String(value);
      if (str.includes('"') || str.includes(',') || str.includes('\n')) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    }

    function downloadFilteredCSV() {
      const filtered = getFilteredRecords();
      if (filtered.length === 0) {
        alert("No records match the current filters.");
        return;
      }

      const header = [
        "Date","Barangay","Farmer/Field ID","Crop","Pest (Common)","Scientific Name",
        "Growth Stage","Weather","Sampling Unit","No. Plants","Pest Count / Unit",
        "% Damage","Severity","Notes","Latitude","Longitude"
      ];

      const lines = [header.map(csvEscape).join(",")];

      filtered.forEach(r => {
        const row = [
          r.date || "", r.barangay || "", r.farmerId || "", r.crop || "",
          r.pest || "", r.sci || "", r.growth || "", r.weather || "",
          r.unit || "", r.plants || "", r.pestCount || "", r.damage || "",
          r.severity || "", r.notes || "", r.lat != null ? r.lat : "",
          r.lng != null ? r.lng : ""
        ];
        lines.push(row.map(csvEscape).join(","));
      });

      const csvContent = lines.join("\r\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement("a");
      const today = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = `pest_records_${today}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    document.addEventListener("DOMContentLoaded", () => {
      initMap();
      autoFillDate();
      updateSamplingUnits("", "");
      updateFilterPestOptions();
    });
  </script>
</body>
</html>
