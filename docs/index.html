<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pest Monitoring ‚Äì Simple Stable Version</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 16px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #fff;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h1, h2 {
      margin-top: 0.5em;
      margin-bottom: 0.3em;
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .field-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 8px;
    }
    .field-group label {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 3px;
    }
    .field-group input,
    .field-group select,
    .field-group textarea {
      padding: 5px 8px;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-width: 140px;
    }
    textarea { resize: vertical; min-height: 50px; }
    .btn {
      padding: 8px 14px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      margin-right: 6px;
      margin-top: 8px;
    }
    .btn-primary { background:#1976d2; color:white; }
    .btn-secondary { background:#e0e0e0; color:#333; }
    .btn-warning { background:#fbc02d; color:#333; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 0.85rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
    }
    thead { background:#eee; }
    tr:nth-child(even) { background:#fafafa; }

    .severity-low    { background:#c6efce; }
    .severity-mod    { background:#ffeb9c; }
    .severity-high   { background:#ffc7ce; }

    #map {
      width: 100%;
      height: 350px;
      margin-top: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .status {
      font-size: 0.8rem;
      margin-top: 4px;
    }
    .status-ok { color:#2e7d32; }
    .status-err { color:#c62828; }
  </style>
</head>
<body>
<div class="container">
  <h1>Pest Monitoring ‚Äì Simple Cloud Version</h1>
  <p style="font-size:0.8rem;">
    Severity rule: <b>Low</b> &lt;10% | <b>Moderate</b> 10‚Äì30% | <b>High</b> &gt;30%.<br>
    This version is simplified so that <b>Add Record always works</b> even if some fields are blank.
  </p>

  <!-- FORM -->
  <h2>Farmer Field Form</h2>
  <form id="pestForm">
    <div class="flex-row">
      <div class="field-group">
        <label for="date">Date</label>
        <input type="date" id="date">
      </div>
      <div class="field-group">
        <label for="barangay">Barangay</label>
        <input type="text" id="barangay" placeholder="e.g. San Juan">
      </div>
      <div class="field-group">
        <label for="farmerId">Farmer / Field ID</label>
        <input type="text" id="farmerId" placeholder="e.g. F-01">
      </div>

      <div class="field-group">
        <label for="crop">Crop</label>
        <select id="crop">
          <option value="">-- select --</option>
          <option>Rice</option>
          <option>Corn</option>
          <option>Cassava</option>
          <option>Tomato</option>
          <option>Eggplant</option>
          <option>Okra</option>
        </select>
      </div>
      <div class="field-group">
        <label for="pest">Pest (common name)</label>
        <select id="pest">
          <option value="">-- select --</option>
          <option>Rice stem borer</option>
          <option>Brown planthopper</option>
          <option>Whitefly</option>
          <option>Aphids</option>
          <option>Tomato fruitworm</option>
          <option>Eggplant fruit and shoot borer</option>
        </select>
      </div>
      <div class="field-group">
        <label for="damage">Percent damage (%)</label>
        <input type="number" id="damage" min="0" max="100" step="0.1">
      </div>

      <div class="field-group">
        <label for="lat">Latitude</label>
        <input type="number" id="lat" step="0.000001" placeholder="optional">
      </div>
      <div class="field-group">
        <label for="lng">Longitude</label>
        <input type="number" id="lng" step="0.000001" placeholder="optional">
      </div>
      <div class="field-group">
        <label>&nbsp;</label>
        <button type="button" class="btn btn-secondary" id="locBtn">üìç Use my location</button>
      </div>

      <div class="field-group" style="flex:1 1 250px;">
        <label for="notes">Notes / Recommendation</label>
        <textarea id="notes" placeholder="Short notes‚Ä¶"></textarea>
      </div>
    </div>

    <div>
      <button type="button" class="btn btn-primary" id="addBtn">‚ûï Add Record</button>
      <button type="button" class="btn btn-secondary" id="clearBtn">Clear Form</button>
      <button type="button" class="btn btn-warning" id="loadBtn">‚¨á Load from Google Sheet</button>
    </div>
    <div id="syncStatus" class="status"></div>
  </form>

  <!-- MAP -->
  <h2>Map of Pest Records</h2>
  <div id="map"></div>

  <!-- TABLE -->
  <h2>Encoded Records</h2>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Barangay</th>
        <th>Farmer</th>
        <th>Crop</th>
        <th>Pest</th>
        <th>% Damage</th>
        <th>Severity</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody id="dataBody"></tbody>
  </table>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  // ===== CONFIG =====
  const SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxkrvX8wVXZJf-zo3qyzjBxYEzXxuEsZHAqXi8GJ-6RbyluQdTKE8P62aLa7FSxomKD/exec"; // <-- replace this

  // ===== STATE =====
  const records = [];
  let map, markersLayer;

  function computeSeverity(dmg) {
    if (dmg == null || isNaN(dmg)) return "";
    const v = Number(dmg);
    if (v < 10) return "Low";
    if (v < 30) return "Moderate";
    return "High";
  }

  function autoFillDate() {
    const d = document.getElementById("date");
    if (!d.value) {
      d.value = new Date().toISOString().slice(0,10);
    }
  }

  function initMap() {
    map = L.map('map').setView([12.5, 122], 5);  // Philippines view
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
  }

  function clearForm() {
    document.getElementById("pestForm").reset();
    autoFillDate();
    const status = document.getElementById("syncStatus");
    status.textContent = "";
    status.className = "status";
  }

  function severityClass(sev) {
    if (sev === "Low") return "severity-low";
    if (sev === "Moderate") return "severity-mod";
    if (sev === "High") return "severity-high";
    return "";
  }

  function addRowToTable(rec) {
    const tb = document.getElementById("dataBody");
    const tr = document.createElement("tr");
    const cells = [
      rec.date || "",
      rec.barangay || "",
      rec.farmerId || "",
      rec.crop || "",
      rec.pest || "",
      rec.damage != null ? rec.damage : "",
      rec.severity || "",
      rec.notes || ""
    ];
    cells.forEach((v, i) => {
      const td = document.createElement("td");
      td.textContent = v;
      if (i === 6) td.className = severityClass(rec.severity);
      tr.appendChild(td);
    });
    tb.appendChild(tr);
  }

  function addMarker(rec) {
    if (!rec.lat || !rec.lng || isNaN(rec.lat) || isNaN(rec.lng)) return;
    const marker = L.marker([rec.lat, rec.lng]);
    marker.bindPopup(
      `<b>${rec.crop || "Unknown crop"}</b><br>` +
      `${rec.pest || ""}<br>` +
      `Damage: ${rec.damage || 0}% (${rec.severity || "-"})<br>` +
      `Barangay: ${rec.barangay || "-"}`
    );
    markersLayer.addLayer(marker);
  }

  function sendToGoogleSheet(rec) {
    if (!SHEET_WEBAPP_URL || SHEET_WEBAPP_URL.includes("YOUR_WEB_APP_URL_HERE")) {
      console.warn("SHEET_WEBAPP_URL not set ‚Äì skipping POST");
      return;
    }
    fetch(SHEET_WEBAPP_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(rec)
    }).catch(err => {
      console.error("POST error:", err);
    });
  }

  function addRecord() {
    const data = {
      date: document.getElementById("date").value,
      barangay: document.getElementById("barangay").value.trim(),
      farmerId: document.getElementById("farmerId").value.trim(),
      crop: document.getElementById("crop").value,
      pest: document.getElementById("pest").value,
      damage: document.getElementById("damage").value,
      notes: document.getElementById("notes").value.trim(),
      lat: parseFloat(document.getElementById("lat").value),
      lng: parseFloat(document.getElementById("lng").value)
    };

    // Make damage optional
    if (data.damage === "" || isNaN(data.damage)) {
      data.damage = null;
    } else {
      data.damage = Number(data.damage);
    }
    data.severity = computeSeverity(data.damage);

    if (isNaN(data.lat)) data.lat = null;
    if (isNaN(data.lng)) data.lng = null;

    records.push(data);
    addRowToTable(data);
    addMarker(data);
    sendToGoogleSheet(data);

    const status = document.getElementById("syncStatus");
    status.textContent = "Record added locally (saving to Google Sheet if URL is set)‚Ä¶";
    status.className = "status status-ok";

    clearForm();
  }

  function loadFromSheet() {
    const status = document.getElementById("syncStatus");
    status.textContent = "Loading from Google Sheet‚Ä¶";
    status.className = "status";

    if (!SHEET_WEBAPP_URL || SHEET_WEBAPP_URL.includes("YOUR_WEB_APP_URL_HERE")) {
      status.textContent = "No SHEET_WEBAPP_URL configured.";
      status.className = "status status-err";
      return;
    }

    fetch(SHEET_WEBAPP_URL)
      .then(r => r.json())
      .then(rows => {
        // clear current
        records.length = 0;
        document.getElementById("dataBody").innerHTML = "";
        markersLayer.clearLayers();

        rows.forEach(r => {
          const rec = {
            date: r.date || "",
            barangay: r.barangay || "",
            farmerId: r.farmerId || "",
            crop: r.crop || "",
            pest: r.pest || "",
            damage: r.damage !== "" ? Number(r.damage) : null,
            severity: r.severity || computeSeverity(r.damage),
            notes: r.notes || "",
            lat: r.lat ? Number(r.lat) : null,
            lng: r.lng ? Number(r.lng) : null
          };
          records.push(rec);
          addRowToTable(rec);
          addMarker(rec);
        });

        status.textContent = "Loaded from Google Sheet ‚úî";
        status.className = "status status-ok";
      })
      .catch(err => {
        console.error("GET error:", err);
        status.textContent = "Error loading from Google Sheet.";
        status.className = "status status-err";
      });
  }

  function useMyLocation() {
    if (!navigator.geolocation) {
      alert("Geolocation not supported.");
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos => {
        const { latitude, longitude } = pos.coords;
        document.getElementById("lat").value = latitude.toFixed(6);
        document.getElementById("lng").value = longitude.toFixed(6);
        if (map) map.setView([latitude, longitude], 16);
      },
      err => {
        console.error(err);
        alert("Unable to get location.");
      }
    );
  }

  document.addEventListener("DOMContentLoaded", () => {
    autoFillDate();
    initMap();
    document.getElementById("addBtn").addEventListener("click", e => {
      e.preventDefault();
      addRecord();
    });
    document.getElementById("clearBtn").addEventListener("click", e => {
      e.preventDefault();
      clearForm();
    });
    document.getElementById("loadBtn").addEventListener("click", e => {
      e.preventDefault();
      loadFromSheet();
    });
    document.getElementById("locBtn").addEventListener("click", e => {
      e.preventDefault();
      useMyLocation();
    });
  });
</script>
</body>
</html>
